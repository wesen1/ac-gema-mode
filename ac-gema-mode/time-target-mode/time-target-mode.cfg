//
// @author wesen
// @copyright 2017-2020 wesen <wesen-ac@web.de>
//

//
// Time target module for ac-gema-mode
//
// Handles printing of comparisons of the current time target to score times and manages shown countdowns.
//
// Requires:
//   * scripts/ac-gema-mode/map-record/map-record-array.cfg
//   * scripts/ac-gema-mode/notification-printer.cfg
//   * scripts/ac-gema-mode/score-attempt/current-score-attempt.cfg
//   * scripts/ac-gema-mode/strings.cfg
//   * scripts/ac-gema-mode/time-target-mode/countdown-mode/countdown-mode.cfg
//   * scripts/ac-gema-mode/time-target-mode/countdown-mode/countdown.cfg
//   * scripts/ac-gema-mode/time-target-mode/current-time-target-mode-state.cfg
//   * scripts/ac-gema-mode/time-target-mode/current-time-target.cfg
//   * scripts/ac-gema-mode/time-target-mode/time-target-auto-updater.cfg
//

// Options

//
// Option to show the difference in milliseconds to the time target on score (Default: 1)
//
// @var int $optionShowDifferenceToTimeTarget
//
check2init optionShowDifferenceToTimeTarget 1;

persistidents 0;


// Public Functions

//
// Returns whether the time target mode is currently active.
//
// @return int 1 if the time target mode is active, 0 otherwise
//
const isTimeTargetModeActive [
  return (&& (isGemaModeActive) (= (getCurrentTimeTargetModeState) 1));
]


// Private Functions

//
// Returns a message that indicates whether the time target was beaten.
//
// @param int scoreTime ($arg1) The score time in milliseconds
//
// @return string The message
//
const getTimeTargetScoreString [

  timeDifference = (- (getCurrentTimeTargetTotalMilliseconds) $arg1);

  if (> $timeDifference 0) [

    if (= $optionShowDifferenceToTimeTarget 1) [
      return (format $messageTimeTargetBeatenWithDifference (generateTimeStringFromMilliseconds $timeDifference 1));
    ][
      return $messageTimeTargetBeaten;
    ]

  ][

    if (= $timeDifference 0) [
      // The score time and time target match, no need to show the difference of 0 milliseconds
      return $messageTimeTargetTied;
    ][
      if (= $optionShowDifferenceToTimeTarget 1) [
        timeDifferenceString = (generateTimeStringFromMilliseconds (* $timeDifference -1) 1);
        return (format $messageSlowerThanTimeTargetWithDifference $timeDifferenceString);
      ][
        return $messageSlowerThanTimeTarget;
      ]
    ]
  ]

]

//
// Starts a new countdown for the current time target.
//
// @param int countdownDuration ($arg1) The countdown duration in milliseconds
//
const startTimeTargetCountdown [
  timeTargetCountdownMilliseconds = $arg1;
  if (> $timeTargetCountdownMilliseconds 0) [
    startCountdown $timeTargetCountdownMilliseconds $messageTimeTargetFinished;
  ]
]


// Event handlers

//
// Event handler that is called when the time target is changed via the "changeCurrentTimeTarget" function.
//
checkinit onTimeTargetChanged [

  if (isCountdownModeActive) [

    // Abort the running countdown
    if (isCountdownActive) [
      abortCountdown;
    ]

    // Start a new countdown with the remaining time target time
    startTimeTargetCountdown (- (getCurrentTimeTargetTotalMilliseconds) (getMillisecondsPassedSinceCurrentScoreAttemptStart));

  ]

]

//
// Event handler that is called after the current score attempt was started.
//
checkinit onCurrentScoreAttemptStarted [
  if (isCountdownModeActive) [
    startTimeTargetCountdown (getCurrentTimeTargetTotalMilliseconds);
  ]
]

//
// Event handler that is called after the current score attempt was finished.
//
// @param array scoreAttemptMapRecord ($arg1) The map record that was created from the score attempt
// @param array comparisonMapRecord ($arg2) The map record to which the score attempt map record will be compared
//
checkinit onCurrentScoreAttemptFinished [

  if (&& (isTimeTargetModeActive) (> (getCurrentTimeTargetTotalMilliseconds) 0)) [

    mapRecord = $arg1;
    scoreAttemptCompareTime = (getMapRecordScoreTime $arg2);

    if (isCountdownActive) [
      abortCountdown;
    ]

    // Don't show the score string when the time target matches the score time compare value because
    // the score string and time target string would show the same information in that case
    if (!= (getCurrentTimeTargetTotalMilliseconds) $scoreAttemptCompareTime) [
      printGemaNotification (getTimeTargetScoreString (getMapRecordScoreTime $mapRecord));
    ]

  ]

]

//
// Event handler that is called after the current score attempt was aborted.
//
checkinit onCurrentScoreAttemptAborted [
  if (isCountdownActive) [
    abortCountdown;
  ]
]
